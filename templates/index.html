<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Polaroid Maker â€“ Print-Ready Photo Converter</title>
  <meta name="description" content="Transform your photos into perfectly bordered, print-ready Polaroid layouts with cut marks. Upload, process, and download in seconds." />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
</head>
<body>
  <div class="bg-orbs">
    <div class="orb orb-1"></div>
    <div class="orb orb-2"></div>
    <div class="orb orb-3"></div>
  </div>

  <main class="container">
    <!-- Header -->
    <header class="header">
      <div class="logo">
        <span class="logo-icon">ðŸ“¸</span>
        <h1>Polaroid <span class="accent">Maker</span></h1>
      </div>
      <p class="tagline">Transform your photos into print-ready Polaroid layouts â€” complete with borders &amp; cut marks.</p>
    </header>

    <!-- Upload Card -->
    <section class="card upload-card">
      <div
        id="drop-zone"
        class="drop-zone"
        role="button"
        aria-label="Upload photos"
        tabindex="0"
      >
        <div class="drop-zone__inner">
          <div class="drop-zone__icon">
            <svg width="56" height="56" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
              <polyline points="17 8 12 3 7 8"/>
              <line x1="12" y1="3" x2="12" y2="15"/>
            </svg>
          </div>
          <p class="drop-zone__label">Drag &amp; drop photos here</p>
          <p class="drop-zone__sub">or</p>
          <label class="btn btn--secondary" for="file-input" id="browse-label">Browse Files</label>
          <input
            type="file"
            id="file-input"
            name="images"
            accept="image/*"
            multiple
            aria-label="Select photos to upload"
          />
          <div id="file-badge" class="file-badge hidden">
            <span id="file-count"></span> photo(s) selected
          </div>
          <p class="drop-zone__formats">JPG Â· PNG Â· WEBP Â· BMP Â· TIFF</p>
        </div>
      </div>

      <!-- File list preview -->
      <ul id="file-list" class="file-list" aria-label="Selected files"></ul>

      <!-- Process button -->
      <button id="process-btn" class="btn btn--primary btn--full" disabled>
        <span id="btn-text">Select photos to begin</span>
        <div id="btn-spinner" class="spinner hidden" aria-hidden="true"></div>
      </button>

      <!-- Error message -->
      <div id="error-msg" class="alert alert--error hidden" role="alert"></div>
    </section>

    <!-- Progress / result -->
    <section id="result-section" class="card result-card hidden" aria-live="polite">
      <div id="progress-state" class="state hidden">
        <div class="big-spinner"></div>
        <p>Processing your photosâ€¦</p>
        <p class="sub">This may take a moment depending on photo size.</p>
      </div>
      <div id="success-state" class="state hidden">
        <div class="success-icon">âœ…</div>
        <h2>Your Polaroids are ready!</h2>
        <p class="sub">All photos have been processed with borders and cut marks.</p>
        <a id="download-link" href="#" class="btn btn--primary btn--download" download="polaroids_to_print.zip">
          â¬‡ Download polaroids_to_print.zip
        </a>
        <button id="reset-btn" class="btn btn--ghost">Process more photos</button>
      </div>
    </section>

    <!-- How it works -->
    <section class="card info-card">
      <h2 class="info-card__title">How it works</h2>
      <ol class="steps">
        <li class="step">
          <span class="step__num">1</span>
          <div>
            <strong>Upload</strong>
            <p>Drop any photos â€” any size or orientation.</p>
          </div>
        </li>
        <li class="step">
          <span class="step__num">2</span>
          <div>
            <strong>Process</strong>
            <p>Photos are center-cropped to a square, then a white Polaroid border is added (10% sides/top, 25% bottom chin).</p>
          </div>
        </li>
        <li class="step">
          <span class="step__num">3</span>
          <div>
            <strong>Print &amp; Cut</strong>
            <p>Grey cross marks at each corner guide your scissors for a perfect trim.</p>
          </div>
        </li>
      </ol>
    </section>
  </main>

  <footer class="footer">
    <p>Polaroid Maker &mdash; print your memories âœ¨</p>
  </footer>

  <script>
    const dropZone    = document.getElementById('drop-zone');
    const fileInput   = document.getElementById('file-input');
    const processBtn  = document.getElementById('process-btn');
    const btnText     = document.getElementById('btn-text');
    const btnSpinner  = document.getElementById('btn-spinner');
    const fileBadge   = document.getElementById('file-badge');
    const fileCount   = document.getElementById('file-count');
    const fileList    = document.getElementById('file-list');
    const errorMsg    = document.getElementById('error-msg');
    const resultSection = document.getElementById('result-section');
    const progressState = document.getElementById('progress-state');
    const successState  = document.getElementById('success-state');
    const downloadLink  = document.getElementById('download-link');
    const resetBtn      = document.getElementById('reset-btn');

    let selectedFiles = [];

    // â”€â”€ Drag & drop â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    ['dragenter', 'dragover'].forEach(evt =>
      dropZone.addEventListener(evt, e => { e.preventDefault(); dropZone.classList.add('drop-zone--active'); })
    );
    ['dragleave', 'drop'].forEach(evt =>
      dropZone.addEventListener(evt, e => { e.preventDefault(); dropZone.classList.remove('drop-zone--active'); })
    );
    dropZone.addEventListener('drop', e => {
      handleFiles([...e.dataTransfer.files]);
    });
    dropZone.addEventListener('click', e => {
      if (e.target.id !== 'browse-label') fileInput.click();
    });
    dropZone.addEventListener('keydown', e => {
      if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); fileInput.click(); }
    });
    fileInput.addEventListener('change', () => {
      handleFiles([...fileInput.files]);
    });

    function handleFiles(files) {
      const images = files.filter(f => f.type.startsWith('image/'));
      if (!images.length) {
        showError('Please select at least one image file.');
        return;
      }
      clearError();
      selectedFiles = images;
      updateFileUI();
    }

    function updateFileUI() {
      const count = selectedFiles.length;
      fileBadge.classList.toggle('hidden', count === 0);
      fileCount.textContent = count;

      fileList.innerHTML = '';
      selectedFiles.forEach(f => {
        const li = document.createElement('li');
        li.className = 'file-list__item';
        li.innerHTML = `<span class="file-list__icon">ðŸ–¼</span><span class="file-list__name">${escapeHtml(f.name)}</span><span class="file-list__size">${formatSize(f.size)}</span>`;
        fileList.appendChild(li);
      });

      processBtn.disabled = count === 0;
      btnText.textContent = count > 0 ? `Process ${count} photo${count > 1 ? 's' : ''}` : 'Select photos to begin';
    }

    // â”€â”€ Upload & process â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    processBtn.addEventListener('click', async () => {
      if (!selectedFiles.length) return;
      setLoading(true);
      clearError();
      showSection('progress');

      const formData = new FormData();
      selectedFiles.forEach(f => formData.append('images', f));

      try {
        const response = await fetch('/upload', { method: 'POST', body: formData });

        if (!response.ok) {
          const data = await response.json().catch(() => ({}));
          throw new Error(data.error || `Server error ${response.status}`);
        }

        const blob = await response.blob();
        const url = URL.createObjectURL(blob);
        downloadLink.href = url;
        showSection('success');
      } catch (err) {
        showSection('none');
        showError(err.message || 'An unexpected error occurred.');
      } finally {
        setLoading(false);
      }
    });

    resetBtn.addEventListener('click', () => {
      selectedFiles = [];
      fileInput.value = '';
      updateFileUI();
      showSection('none');
      clearError();
    });

    // â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function setLoading(on) {
      processBtn.disabled = on;
      btnSpinner.classList.toggle('hidden', !on);
      btnText.textContent = on ? 'Processingâ€¦' : `Process ${selectedFiles.length} photo${selectedFiles.length > 1 ? 's' : ''}`;
    }

    function showSection(state) {
      resultSection.classList.toggle('hidden', state === 'none');
      progressState.classList.toggle('hidden', state !== 'progress');
      successState.classList.toggle('hidden', state !== 'success');
    }

    function showError(msg) {
      errorMsg.textContent = msg;
      errorMsg.classList.remove('hidden');
    }

    function clearError() {
      errorMsg.classList.add('hidden');
      errorMsg.textContent = '';
    }

    function formatSize(bytes) {
      if (bytes < 1024) return bytes + ' B';
      if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
      return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    }

    function escapeHtml(str) {
      return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    }
  </script>
</body>
</html>
